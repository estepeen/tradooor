// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl is optional - only needed for migrate dev, not for migrate deploy or db push
  // If you need it for local development, add DIRECT_URL to .env
}

/// Reprezentuje trackovanou adresu (smart wallet) na Solaně
model SmartWallet {
  id                        String    @id @default(cuid())
  address                   String    @unique // Solana wallet address
  label                     String? // Volitelné jméno/label (např. "Trader X", "Call channel Y")
  tags                      String[]  @default([]) // Tagy pro kategorizaci (např. ["degen", "sniper", "calls"])
  twitterUrl                String? // Twitter/X profil URL (např. "https://x.com/username")
  lastPumpfunTradeTimestamp DateTime? // Poslední Pump.fun trade (pro backfill a monitoring)

  // Manual trader classification
  tier                      Int?      // Trader tier: 1 = best (T1), 2 = good (T2), 3 = decent (T3), null = unclassified
  avgBuyAmountUsd           Float?    // Manually set typical buy amount in USD (for conviction detection)

  // Metriky (průběžně přepočítávané)
  score                       Float   @default(0) // Celkové skóre kvality tradera (0-100)
  score7d                     Float   @default(0) // Skóre založené na posledních 7 dnech (0-100)
  score30d                    Float   @default(0) // Skóre založené na posledních 30 dnech (0-100)
  enhancedScore               Float   @default(0) // Enhanced skóre podle pokročilého modelu (0-100)
  percentileRankWinRate       Float   @default(0) // Percentil win rate (0-1)
  percentileRankRoi           Float   @default(0) // Percentil ROI (0-1)
  positionDisciplineScore     Float   @default(0) // Skóre disciplíny velikosti pozic (0-100)
  timingIntelligenceScore     Float   @default(0) // Skóre timingu vstupů/výstupů (0-100)
  categorySpecializationBonus Float   @default(0) // Bonus za specializaci v kategorii (0-15)
  marketRegime                String? // 'bull' | 'bear' | 'sideways' (současný tržní režim při výpočtu skóre)
  totalTrades                 Int     @default(0) // Celkový počet tradeů
  winRate                     Float   @default(0) // Win rate (0-1, např. 0.65 = 65%)
  avgRr                       Float   @default(0) // Průměrný risk/reward poměr
  avgPnlPercent               Float   @default(0) // Průměrné % na trade
  pnlTotalBase                Float   @default(0) // Celkový PnL v base měně (SOL/USDC/USDT)
  avgHoldingTimeMin           Float   @default(0) // Průměrná doba držení pozice v minutách
  maxDrawdownPercent          Float   @default(0) // Maximální drawdown v %
  recentPnl7dPercent          Float   @default(0) // PnL za posledních 7 dní v %
  recentPnl7dBase             Float   @default(0) // PnL for last 7 days in base currency (SOL/USDC/USDT)
  recentPnl30dPercent         Float   @default(0) // PnL za posledních 30 dní v %
  recentPnl30dBase            Float   @default(0) // PnL for last 30 days in base currency (SOL/USDC/USDT)
  advancedStats               Json? // Cached advanced stats (profit factor, streaks, etc.)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trades           Trade[]
  tradeFeatures    TradeFeature[]
  metricsHistory   SmartWalletMetricsHistory[]
  processingJobs   WalletProcessingQueue[]
  tradeSequences   TradeSequence[]
  tradeOutcomes    TradeOutcome[]
  normalizedTrades NormalizedTrade[]
  closedLots       ClosedLot[]
  signals          Signal[]
  correlationsAsA  WalletCorrelation[]         @relation("CorrelationA")
  correlationsAsB  WalletCorrelation[]         @relation("CorrelationB")
  positionActivities PositionWalletActivity[]

  @@index([address])
  @@index([score])
  @@index([tier])
  @@index([updatedAt])
}

/// Základní informace o tokenech, které se v obchodech objevují
model Token {
  id          String   @id @default(cuid())
  mintAddress String   @unique // Solana token mint address
  symbol      String? // Symbol tokenu (např. "SOL", "USDC")
  name        String? // Název tokenu
  decimals    Int      @default(9) // Počet desetinných míst
  firstSeenAt DateTime @default(now()) // Kdy byl token poprvé viděn v systému
  updatedAt   DateTime @updatedAt

  trades             Trade[]
  tradeFeatures      TradeFeature[]
  marketSnapshots    TokenMarketSnapshot[]
  tradeSequences     TradeSequence[]
  tradeOutcomes      TradeOutcome[]
  normalizedTrades   NormalizedTrade[]
  consensusSignals   ConsensusSignal[]
  closedLots         ClosedLot[]
  signals            Signal[]
  signalPerformances SignalPerformance[]
  virtualPositions   VirtualPosition[]
  exitSignals        ExitSignal[]

  @@index([mintAddress])
  @@index([symbol])
}

/// Jednotlivé trady smart wallets (per TX/per fill, ideálně per swap)
model Trade {
  id                    String   @id @default(cuid())
  txSignature           String   @unique // Solana transaction signature
  walletId              String
  tokenId               String
  side                  String // 'buy' | 'sell'
  amountToken           Decimal  @db.Decimal(36, 18) // Množství tokenů
  amountBase            Decimal  @db.Decimal(36, 18) // Hodnota v SOL nebo jiném base assetu (USDC/USDT)
  priceBasePerToken     Decimal  @db.Decimal(36, 18) // Cena v base měně za 1 token
  valueUsd              Decimal? @db.Decimal(36, 18) // Hodnota obchodu v USD
  pnlUsd                Decimal? @db.Decimal(36, 18) // Realizovaný PnL v USD (pokud k dispozici)
  pnlPercent            Decimal? @db.Decimal(36, 18) // Realizovaný PnL v %
  positionChangePercent Decimal? @db.Decimal(36, 18) // Změna velikosti pozice (pro analytiku)
  timestamp             DateTime // Čas transakce
  dex                   String // Identifikace DEXu (např. "pumpfun", "raydium", "jupiter", "orca")
  positionId            String? // Volitelné - FK na logickou pozici (pro budoucí rozšíření)
  meta                  Json? // Doplňkové údaje v JSON formátu

  wallet           SmartWallet       @relation(fields: [walletId], references: [id], onDelete: Cascade)
  token            Token             @relation(fields: [tokenId], references: [id], onDelete: Cascade)
  features         TradeFeature?
  sequence         TradeSequence?
  outcome          TradeOutcome?
  normalizedTrades NormalizedTrade[]

  @@index([walletId])
  @@index([tokenId])
  @@index([timestamp])
  @@index([walletId, timestamp])
}

/// Snapshot trhu pro daný token v čase (agregace v intervalech, např. 1 minuta / 5 minut)
/// Volitelné, ale užitečné pro analýzu trhu
model TokenMarketSnapshot {
  id                 String   @id @default(cuid())
  tokenId            String
  timestamp          DateTime // Čas snapshotu
  price              Decimal  @db.Decimal(36, 18) // Cena tokenu v base měně
  liquidity          Decimal  @db.Decimal(36, 18) // Velikost LP (liquidity pool)
  volume1m           Decimal  @db.Decimal(36, 18) // Objem za 1 minutu
  volume5m           Decimal  @db.Decimal(36, 18) // Objem za 5 minut
  holdersCount       Int? // Počet holderů (volitelné, pokud bude možné získat)
  smartWalletHolders Int      @default(0) // Kolik z našich smart wallets ten token aktuálně drží

  token Token @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  @@index([tokenId])
  @@index([timestamp])
  @@index([tokenId, timestamp])
}

/// Verzování metrik v čase - historické hodnoty metrik wallet
/// Přepočítáváno periodicky (např. 1x denně) pro grafy v dashboardu
model SmartWalletMetricsHistory {
  id                  String   @id @default(cuid())
  walletId            String
  timestamp           DateTime // Čas přepočtu metrik
  score               Float // Celkové skóre kvality tradera (0-100)
  totalTrades         Int // Celkový počet tradeů
  winRate             Float // Win rate (0-1)
  avgRr               Float // Průměrný risk/reward poměr
  avgPnlPercent       Float // Průměrné % na trade
  pnlTotalBase        Float // Celkový PnL v base měně
  avgHoldingTimeMin   Float // Průměrná doba držení pozice v minutách
  maxDrawdownPercent  Float // Maximální drawdown v %
  recentPnl30dPercent Float // PnL za posledních 30 dní v %

  wallet SmartWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([timestamp])
  @@index([walletId, timestamp])
}

model TradeFeature {
  id                           String    @id @default(cuid())
  tradeId                      String    @unique
  walletId                     String
  tokenId                      String
  sizeToken                    Decimal?  @db.Decimal(36, 18)
  sizeUsd                      Decimal?  @db.Decimal(36, 18)
  priceUsd                     Decimal?  @db.Decimal(36, 18)
  slippageBps                  Int?
  dex                          String?
  txTimestamp                  DateTime?
  positionSizeBeforeToken      Decimal?  @db.Decimal(36, 18)
  positionSizeBeforeUsd        Decimal?  @db.Decimal(36, 18)
  positionSizeAfterToken       Decimal?  @db.Decimal(36, 18)
  positionSizeAfterUsd         Decimal?  @db.Decimal(36, 18)
  positionSizeChangeMultiplier Decimal?  @db.Decimal(36, 18)
  avgEntryPriceBeforeUsd       Decimal?  @db.Decimal(36, 18)
  avgEntryPriceAfterUsd        Decimal?  @db.Decimal(36, 18)
  realizedPnlUsd               Decimal?  @db.Decimal(36, 18)
  realizedPnlPercent           Decimal?  @db.Decimal(36, 18)
  holdTimeSeconds              Int?
  tokenAgeSeconds              Int?
  liquidityUsd                 Decimal?  @db.Decimal(36, 18)
  volume1hUsd                  Decimal?  @db.Decimal(36, 18)
  volume24hUsd                 Decimal?  @db.Decimal(36, 18)
  fdvUsd                       Decimal?  @db.Decimal(36, 18)
  trend5mPercent               Decimal?  @db.Decimal(36, 18)
  trend30mPercent              Decimal?  @db.Decimal(36, 18)
  solPriceUsd                  Decimal?  @db.Decimal(36, 18)
  hourOfDay                    Int?
  dayOfWeek                    Int?
  baseTokenSymbol              String?
  meta                         Json?
  createdAt                    DateTime  @default(now())
  updatedAt                    DateTime  @updatedAt

  // Enhanced scoring features
  entryRankPercentile Decimal? @db.Decimal(36, 18) // Kdy wallet vstoupila relativně k ostatním (0-1, lower = earlier)
  exitEfficiency      Decimal? @db.Decimal(36, 18) // Jak blízko k lokálnímu maximu/minimu exitoval trade (0-1)
  tokenCategory       String? // Např. 'meme', 'defi', 'nft' – pro category specialization

  // Market context features (pro AI/ML)
  priceMomentum1mPercent                     Decimal? @db.Decimal(36, 18) // Změna ceny 1 min před trade
  priceMomentum5mPercent                     Decimal? @db.Decimal(36, 18) // Změna ceny 5 min před trade
  priceMomentum15mPercent                    Decimal? @db.Decimal(36, 18) // Změna ceny 15 min před trade
  priceMomentum1hPercent                     Decimal? @db.Decimal(36, 18) // Změna ceny 1h před trade
  volumeSpike1hMultiplier                    Decimal? @db.Decimal(36, 18) // Násobek průměrného objemu (1h)
  volumeSpike24hMultiplier                   Decimal? @db.Decimal(36, 18) // Násobek průměrného objemu (24h)
  marketRegime                               String? // 'bull' | 'bear' | 'sideways' (na základě SOL price)
  otherSmartWalletsTradingCount              Int? // Kolik dalších smart wallets tradeuje stejný token
  otherSmartWalletsTradingSameTokenCount     Int? // Total count of other smart wallets trading same token
  otherSmartWalletsTradingSameTokenWithin1h  Int? // Count within 1 hour
  otherSmartWalletsTradingSameTokenWithin24h Int? // Count within 24 hours
  avgTimeSinceOtherTradersTradeSeconds       Int? // Average time since other traders traded same token
  copyTraderScore                            Decimal? @db.Decimal(5, 4) // Copy trading score (0-1)

  trade  Trade       @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  wallet SmartWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
  token  Token       @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([tokenId])
  @@index([txTimestamp])
}

model WalletProcessingQueue {
  id            String    @id @default(cuid())
  walletId      String
  jobType       String    @default("metrics")
  status        String    @default("pending")
  priority      Int       @default(0)
  attempts      Int       @default(0)
  lastAttemptAt DateTime?
  nextRunAt     DateTime  @default(now())
  error         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  wallet SmartWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@unique([walletId, jobType])
  @@index([status, nextRunAt])
  @@index([priority, createdAt])
}

/// Sequence data pro AI/ML - pořadí tradeů, time between trades, patterns
/// SEPAROVÁNO od současných fungujících věcí - pouze pro AI/ML trénink
model TradeSequence {
  id       String @id @default(cuid())
  tradeId  String @unique
  walletId String
  tokenId  String

  // Sequence context
  sequenceIndex                  Int? // Pořadí tradeu v sekvenci (1, 2, 3, ...)
  sequenceLength                 Int? // Celková délka sekvence tradeů
  timeSinceLastTradeSeconds      Int? // Čas od posledního tradeu (v sekundách)
  timeSinceLastTokenTradeSeconds Int? // Čas od posledního tradeu se stejným tokenem

  // Token switching patterns
  isTokenSwitch    Boolean? @default(false) // Změnil trader token?
  previousTokenId  String? // Předchozí token (pokud se změnil)
  tokensInSequence Int? // Kolik různých tokenů v sekvenci

  // Position sizing patterns
  positionSizeChangePercent Decimal? @db.Decimal(36, 18) // Změna velikosti pozice vs. předchozí trade
  avgPositionSizeUsd        Decimal? @db.Decimal(36, 18) // Průměrná velikost pozice v sekvenci

  // Trading frequency
  tradesInLastHour Int? // Počet tradeů v poslední hodině
  tradesInLastDay  Int? // Počet tradeů v posledním dni

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trade  Trade       @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  wallet SmartWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
  token  Token       @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([tokenId])
  @@index([tradeId])
}

/// Outcome labels pro AI/ML - explicitní labely pro supervised learning
/// SEPAROVÁNO od současných fungujících věcí - pouze pro AI/ML trénink
model TradeOutcome {
  id       String @id @default(cuid())
  tradeId  String @unique
  walletId String
  tokenId  String

  // Trade outcome (pro BUY trades)
  outcomeType        String? // 'win' | 'loss' | 'breakeven' | 'unknown'
  outcomeCategory    String? // 'big_win' | 'small_win' | 'small_loss' | 'big_loss' | 'breakeven'
  realizedPnlUsd     Decimal? @db.Decimal(36, 18) // Realizovaný PnL (pro SELL trades)
  realizedPnlPercent Decimal? @db.Decimal(36, 18) // Realizovaný PnL % (pro SELL trades)

  // Token outcome (jak dopadl token po trade)
  tokenPriceChange1hPercent  Decimal? @db.Decimal(36, 18) // Změna ceny tokenu 1h po trade
  tokenPriceChange24hPercent Decimal? @db.Decimal(36, 18) // Změna ceny tokenu 24h po trade
  tokenPriceChange7dPercent  Decimal? @db.Decimal(36, 18) // Změna ceny tokenu 7d po trade
  tokenOutcome               String? // 'pump' | 'dump' | 'sideways' | 'unknown'

  // Position outcome (celkový výsledek pozice)
  positionClosedAt        DateTime? // Kdy byla pozice uzavřena (pokud už byla)
  positionHoldTimeSeconds Int? // Jak dlouho byla pozice držena
  positionFinalPnlUsd     Decimal?  @db.Decimal(36, 18) // Finální PnL pozice
  positionFinalPnlPercent Decimal?  @db.Decimal(36, 18) // Finální PnL % pozice

  // Labels calculated at
  calculatedAt DateTime @default(now())
  updatedAt    DateTime @updatedAt

  trade  Trade       @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  wallet SmartWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
  token  Token       @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([tokenId])
  @@index([tradeId])
  @@index([outcomeType])
  @@index([outcomeCategory])
}

model NormalizedTrade {
  id                    String    @id @default(cuid())
  txSignature           String
  walletId              String
  tokenId               String
  tokenMint             String
  side                  String
  amountToken           Decimal   @db.Decimal(36, 18)
  amountBaseRaw         Decimal   @db.Decimal(36, 18)
  baseToken             String
  priceBasePerTokenRaw  Decimal   @db.Decimal(36, 18)
  timestamp             DateTime
  dex                   String
  positionChangePercent Float?
  balanceBefore         Float?
  balanceAfter          Float?
  status                String    @default("pending")
  error                 String?
  meta                  Json?
  rawPayload            Json?
  amountBaseUsd         Decimal?  @db.Decimal(36, 18)
  priceUsdPerToken      Decimal?  @db.Decimal(36, 18)
  valuationSource       String?
  valuationTimestamp    DateTime?
  processedAt           DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  tradeId               String?

  trade  Trade?      @relation(fields: [tradeId], references: [id], onDelete: SetNull)
  wallet SmartWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
  token  Token       @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  @@unique([txSignature, walletId, side])
  @@index([status, timestamp])
  @@index([walletId, status])
}

/// Consensus trading signals - when 2+ wallets buy the same token within 2 hours
model ConsensusSignal {
  id              String   @id @default(cuid())
  tokenId         String
  walletCount     Int // Number of unique wallets in consensus
  firstTradeTime  DateTime // Time of first trade in consensus
  latestTradeTime DateTime // Time of latest trade in consensus
  trades          Json // Array of trade data (wallet, amount, price, timestamp, etc.)
  tokenSecurity   Json? // Token security data (honeypot, tax, marketcap, etc.)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  token Token @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  @@index([tokenId])
  @@index([latestTradeTime])
  @@index([createdAt])
  @@index([tokenId, firstTradeTime])
}

/// Realized closed lots (uzavřené pozice) pro detailní PnL analýzu
model ClosedLot {
  id                        String   @id @default(cuid())
  walletId                  String
  tokenId                   String
  size                      Decimal  @db.Decimal(36, 18)
  entryPrice                Decimal  @db.Decimal(36, 18)
  exitPrice                 Decimal  @db.Decimal(36, 18)
  entryTime                 DateTime
  exitTime                  DateTime
  holdTimeMinutes           Float
  costBasis                 Decimal  @db.Decimal(36, 18)
  proceeds                  Decimal  @db.Decimal(36, 18)
  realizedPnl               Decimal  @db.Decimal(36, 18)
  realizedPnlPercent        Decimal  @db.Decimal(36, 18)
  realizedPnlUsd            Decimal? @db.Decimal(36, 18)
  buyTradeId                String?
  sellTradeId               String? // Should be nullable - if Trade doesn't exist, use NULL
  isPreHistory              Boolean  @default(false)
  costKnown                 Boolean  @default(true)
  sequenceNumber            Int?
  // Timing
  entryHourOfDay            Int?
  entryDayOfWeek            Int?
  exitHourOfDay             Int?
  exitDayOfWeek             Int?
  // Market conditions
  entryMarketCap            Decimal? @db.Decimal(36, 18)
  exitMarketCap             Decimal? @db.Decimal(36, 18)
  entryLiquidity            Decimal? @db.Decimal(36, 18)
  exitLiquidity             Decimal? @db.Decimal(36, 18)
  entryVolume24h            Decimal? @db.Decimal(36, 18)
  exitVolume24h             Decimal? @db.Decimal(36, 18)
  tokenAgeAtEntryMinutes    Float?
  // Exit detection
  exitReason                String?
  maxProfitPercent          Decimal? @db.Decimal(36, 18)
  maxDrawdownPercent        Decimal? @db.Decimal(36, 18)
  timeToMaxProfitMinutes    Float?
  // DCA
  dcaEntryCount             Int?
  dcaTimeSpanMinutes        Float?
  // Re-entry patterns
  reentryTimeMinutes        Float?
  reentryPriceChangePercent Decimal? @db.Decimal(36, 18)
  previousCyclePnl          Decimal? @db.Decimal(36, 18)
  // Timestamps
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  wallet SmartWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
  token  Token       @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([tokenId])
  @@index([exitTime])
}

/// Paper trading trades (simulované obchody)
model PaperTrade {
  id                 String    @id @default(cuid())
  walletId           String
  tokenId            String
  originalTradeId    String?
  side               String
  amountToken        Decimal   @db.Decimal(36, 18)
  amountBase         Decimal   @db.Decimal(36, 18)
  priceBasePerToken  Decimal   @db.Decimal(36, 18)
  timestamp          DateTime
  status             String    @default("open")
  realizedPnl        Decimal?  @db.Decimal(36, 18)
  realizedPnlPercent Decimal?  @db.Decimal(36, 18)
  closedAt           DateTime?
  meta               Json?
}

/// Paper trading portfolio snapshots
model PaperPortfolio {
  id              String   @id @default(cuid())
  timestamp       DateTime @default(now())
  totalValueUsd   Decimal  @db.Decimal(36, 18)
  totalCostUsd    Decimal  @db.Decimal(36, 18)
  totalPnlUsd     Decimal  @db.Decimal(36, 18)
  totalPnlPercent Decimal  @db.Decimal(36, 18)
  openPositions   Int
  closedPositions Int
  winRate         Decimal? @db.Decimal(36, 18)
  totalTrades     Int
  meta            Json?
}

/// Obecné signály (buy/sell) pro AI, consensus atd.
model Signal {
  id                String    @id @default(cuid())
  type              String // 'buy' | 'sell'
  walletId          String
  tokenId           String
  originalTradeId   String?
  priceBasePerToken Decimal   @db.Decimal(36, 18)
  amountBase        Decimal?  @db.Decimal(36, 18)
  amountToken       Decimal?  @db.Decimal(36, 18)
  timestamp         DateTime
  status            String    @default("active") // 'active' | 'executed' | 'expired' | 'cancelled'
  expiresAt         DateTime?
  qualityScore      Decimal?  @db.Decimal(36, 18)
  riskLevel         String?
  model             String? // 'smart-copy' | 'consensus' | 'ai' | ...
  reasoning         String?
  meta              Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  wallet SmartWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
  token  Token       @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  // Signal performance tracking
  performance       SignalPerformance?
  virtualPositions  VirtualPosition[]

  @@index([walletId])
  @@index([tokenId])
  @@index([timestamp])
  @@index([status])
}

/// Cache pro aktuální cenu SOL (aktualizováno každých 10 minut z Binance API)
model SolPriceCache {
  id        String   @id @default("current")
  priceUsd  Float // Aktuální cena SOL v USD
  updatedAt DateTime @default(now()) @updatedAt
  source    String   @default("binance") // Zdroj ceny (např. "binance")

  @@index([updatedAt])
}

/// Wallet Correlation - Tracks trading correlation between pairs of wallets
/// Used for detecting cluster consensus signals (when correlated traders buy together)
model WalletCorrelation {
  id        String @id @default(cuid())
  walletAId String
  walletBId String

  // Shared trading metrics
  sharedTrades   Int   @default(0) // Number of same tokens traded by both
  totalTradesA   Int   @default(0) // Total trades by wallet A
  totalTradesB   Int   @default(0) // Total trades by wallet B
  overlapPercent Float @default(0) // Percentage of shared trades

  // Timing correlation
  avgTimeDiffMinutes Int @default(0) // Average time difference between their trades

  // Performance correlation
  jointSuccessRate  Float @default(0) // Success rate when both trade same token
  profitCorrelation Float @default(0) // Pearson correlation of PnL (-1 to 1)

  // Overall cluster strength (0-100 score)
  clusterStrength Int @default(0)

  // Metadata
  lastCalculated DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  walletA SmartWallet @relation("CorrelationA", fields: [walletAId], references: [id], onDelete: Cascade)
  walletB SmartWallet @relation("CorrelationB", fields: [walletBId], references: [id], onDelete: Cascade)

  @@unique([walletAId, walletBId])
  @@index([clusterStrength(sort: Desc)])
  @@index([walletAId])
  @@index([walletBId])
  @@index([lastCalculated])
}

/// Shared Trade Index - Fast lookup for shared trades between wallet pairs
/// This is a denormalized table for performance (avoids expensive joins)
model SharedTradeIndex {
  id        String @id @default(cuid())
  walletAId String
  walletBId String
  tokenId   String

  // Trade timestamps
  tradeAId        String
  tradeBId        String
  tradeATimestamp DateTime
  tradeBTimestamp DateTime
  timeDiffMinutes Int // Difference in minutes (can be negative)

  // Trade outcomes (for correlation calculation)
  tradeAPnl Float? // PnL of wallet A's trade
  tradeBPnl Float? // PnL of wallet B's trade

  createdAt DateTime @default(now())

  @@unique([tradeAId, tradeBId])
  @@index([walletAId, walletBId])
  @@index([tokenId])
  @@index([tradeATimestamp])
}

// ============================================================================
// SIGNAL PERFORMANCE TRACKING SYSTEM
// ============================================================================

/// Tracks performance of each signal over time - price milestones, max/min, exit analysis
model SignalPerformance {
  id                String   @id @default(cuid())
  signalId          String   @unique
  tokenId           String

  // Entry data
  entryPriceUsd     Decimal  @db.Decimal(36, 18)
  entryMarketCapUsd Decimal? @db.Decimal(36, 18)
  entryLiquidityUsd Decimal? @db.Decimal(36, 18)
  entryTimestamp    DateTime

  // Price tracking
  currentPriceUsd   Decimal? @db.Decimal(36, 18)
  highestPriceUsd   Decimal? @db.Decimal(36, 18)
  lowestPriceUsd    Decimal? @db.Decimal(36, 18)
  highestPriceTime  DateTime?
  lowestPriceTime   DateTime?

  // PnL tracking
  currentPnlPercent Decimal? @db.Decimal(36, 18)
  maxPnlPercent     Decimal? @db.Decimal(36, 18)
  minPnlPercent     Decimal? @db.Decimal(36, 18)
  drawdownFromPeak  Decimal? @db.Decimal(36, 18) // % down from ATH

  // Milestone snapshots (JSON - prices at key intervals)
  // { "5m": 0.001, "15m": 0.0012, "1h": 0.002, ... }
  priceSnapshots    Json?
  pnlSnapshots      Json?    // { "5m": 10.5, "15m": 25.2, "1h": 100.5, ... }

  // Timing analysis
  timeToPeakMinutes   Int?   // How long until max price
  timeToTroughMinutes Int?   // How long until min price

  // Outcome
  status             String  @default("active") // active, closed, expired
  exitReason         String? // sl_hit, tp_hit, trailing_stop, ai_exit, time_based, wallet_exit
  exitPriceUsd       Decimal? @db.Decimal(36, 18)
  exitTimestamp      DateTime?
  realizedPnlPercent Decimal? @db.Decimal(36, 18)

  // Optimal exit analysis (calculated post-close)
  optimalExitPrice   Decimal? @db.Decimal(36, 18)
  optimalExitTime    DateTime?
  missedPnlPercent   Decimal? @db.Decimal(36, 18) // max - actual

  lastUpdated DateTime @default(now()) @updatedAt
  createdAt   DateTime @default(now())

  signal Signal @relation(fields: [signalId], references: [id], onDelete: Cascade)
  token  Token  @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  @@index([signalId])
  @@index([tokenId])
  @@index([status])
  @@index([entryTimestamp])
}

/// Virtual positions created from consensus signals - tracks active holdings
model VirtualPosition {
  id                  String   @id @default(cuid())
  tokenId             String
  signalId            String?
  consensusSignalId   String?

  // Entry data
  entryPriceUsd       Decimal  @db.Decimal(36, 18)
  entryTimestamp      DateTime
  entryWalletCount    Int      @default(1)
  entryMarketCapUsd   Decimal? @db.Decimal(36, 18)
  entryLiquidityUsd   Decimal? @db.Decimal(36, 18)

  // Position tracking
  positionSizeUsd     Decimal? @db.Decimal(36, 18)
  currentPriceUsd     Decimal? @db.Decimal(36, 18)
  lastPriceUpdate     DateTime?

  // PnL tracking
  unrealizedPnlPercent Decimal? @db.Decimal(36, 18)
  unrealizedPnlUsd     Decimal? @db.Decimal(36, 18)

  // Price extremes
  highestPriceUsd     Decimal? @db.Decimal(36, 18)
  lowestPriceUsd      Decimal? @db.Decimal(36, 18)
  drawdownFromPeak    Decimal? @db.Decimal(36, 18)

  // Wallet tracking
  walletIds           String[] // Array of wallet IDs holding this position
  activeWalletCount   Int      @default(0)
  exitedWalletCount   Int      @default(0)

  // Exit strategy
  suggestedStopLoss   Decimal? @db.Decimal(36, 18)
  suggestedTakeProfit Decimal? @db.Decimal(36, 18)
  trailingStopPercent Decimal? @db.Decimal(36, 18)
  trailingStopPrice   Decimal? @db.Decimal(36, 18) // Dynamic trailing stop price

  // Tiered Take Profit tracking
  tp1Hit              Boolean  @default(false)  // +25% hit, sold 60%
  tp1HitAt            DateTime?
  tp2Hit              Boolean  @default(false)  // +40% hit, sold 30%
  tp2HitAt            DateTime?
  tp3Hit              Boolean  @default(false)  // +70% hit, sold 10% (moonbag)
  tp3HitAt            DateTime?
  remainingPercent    Int      @default(100)    // Percentage of position remaining (100 -> 40 -> 10 -> 0)

  // AI exit tracking
  lastAiDecision      String?
  lastAiConfidence    Int?
  lastAiReasoning     String?
  lastAiEvaluation    DateTime?

  // Status
  status              String   @default("open") // open, partial_exit, closed, stopped
  exitReason          String?
  exitPriceUsd        Decimal? @db.Decimal(36, 18)
  exitTimestamp       DateTime?
  realizedPnlPercent  Decimal? @db.Decimal(36, 18)
  realizedPnlUsd      Decimal? @db.Decimal(36, 18)

  // Notifications
  lastNotificationSent DateTime?
  notificationCount    Int     @default(0)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  token               Token    @relation(fields: [tokenId], references: [id], onDelete: Cascade)
  signal              Signal?  @relation(fields: [signalId], references: [id], onDelete: SetNull)
  exitSignals         ExitSignal[]
  walletActivities    PositionWalletActivity[]

  @@index([tokenId])
  @@index([signalId])
  @@index([status])
  @@index([entryTimestamp])
}

/// Exit signals generated for virtual positions
model ExitSignal {
  id                String   @id @default(cuid())
  positionId        String
  tokenId           String

  // Signal type
  type              String   // wallet_exit, stop_loss, take_profit, trailing_stop, ai_recommendation, time_based, momentum_loss, volume_drop
  strength          String   // weak, medium, strong
  recommendation    String   // hold, partial_exit_25, partial_exit_50, partial_exit_75, full_exit

  // Context at signal time
  priceAtSignal     Decimal? @db.Decimal(36, 18)
  pnlPercentAtSignal Decimal? @db.Decimal(36, 18)
  drawdownAtSignal  Decimal? @db.Decimal(36, 18)

  // Wallet exit context
  walletsExitedCount Int?
  walletsHoldingCount Int?
  triggerWalletId    String?
  triggerTradeId     String?
  triggerReason      String?

  // AI context
  aiDecision         String?
  aiConfidence       Int?
  aiReasoning        String?

  // Market context
  marketCapAtSignal  Decimal? @db.Decimal(36, 18)
  liquidityAtSignal  Decimal? @db.Decimal(36, 18)
  volume1hAtSignal   Decimal? @db.Decimal(36, 18)

  // Notification
  notificationSent   Boolean  @default(false)
  notificationSentAt DateTime?
  discordMessageId   String?

  // Outcome (filled when position closes)
  wasActedOn         Boolean? // Did user act on this signal?
  pnlIfActed         Decimal? @db.Decimal(36, 18) // Hypothetical PnL if acted
  pnlActual          Decimal? @db.Decimal(36, 18) // Actual PnL at position close

  createdAt          DateTime @default(now())

  position           VirtualPosition @relation(fields: [positionId], references: [id], onDelete: Cascade)
  token              Token    @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  @@index([positionId])
  @@index([tokenId])
  @@index([type])
  @@index([createdAt])
}

/// Tracks individual wallet activity within a virtual position
model PositionWalletActivity {
  id             String   @id @default(cuid())
  positionId     String
  walletId       String

  // Entry data
  entryTradeId   String?
  entryPriceUsd  Decimal? @db.Decimal(36, 18)
  entryAmountUsd Decimal? @db.Decimal(36, 18)
  entryTimestamp DateTime?

  // Exit data
  exitTradeId    String?
  exitPriceUsd   Decimal? @db.Decimal(36, 18)
  exitAmountUsd  Decimal? @db.Decimal(36, 18)
  exitTimestamp  DateTime?

  // Status
  status         String   @default("holding") // holding, partial_exit, full_exit
  holdingPercent Decimal  @default(100) @db.Decimal(36, 18)

  // PnL
  realizedPnlPercent Decimal? @db.Decimal(36, 18)
  realizedPnlUsd     Decimal? @db.Decimal(36, 18)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  position       VirtualPosition @relation(fields: [positionId], references: [id], onDelete: Cascade)
  wallet         SmartWallet     @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@unique([positionId, walletId])
  @@index([positionId])
  @@index([walletId])
  @@index([status])
}

// ============================================================================
// SPECTRE TRADING BOT
// ============================================================================

/// Trades executed by SPECTRE bot (real mainnet trades)
model SpectreTrade {
  id              String   @id @default(cuid())

  // Signal that triggered this trade
  signalType      String   // 'ninja' | 'consensus'
  signalStrength  String   // 'weak' | 'medium' | 'strong'

  // Token info
  tokenMint       String
  tokenSymbol     String

  // Trade execution
  side            String   // 'buy' | 'sell'
  amountSol       Decimal  @db.Decimal(36, 18)
  amountTokens    Decimal? @db.Decimal(36, 18)
  pricePerToken   Decimal? @db.Decimal(36, 18)
  txSignature     String?  @unique

  // Market context at trade time
  marketCapUsd    Decimal? @db.Decimal(36, 18)
  liquidityUsd    Decimal? @db.Decimal(36, 18)
  entryPriceUsd   Decimal? @db.Decimal(36, 18)

  // Strategy parameters used
  stopLossPercent   Float?
  takeProfitPercent Float?
  slippageBps       Int?
  jitoTipLamports   Int?

  // Execution metrics
  success         Boolean  @default(false)
  error           String?
  latencyMs       Int?     // Time from quote to tx confirmation (execution latency)
  signalToTradeMs Int?     // Time from signal timestamp to trade execution

  // Retry tracking
  attemptNumber   Int      @default(1) // Which attempt (1 = first try, 2 = retry)
  priceAtSignal   Decimal? @db.Decimal(36, 18) // Token price when signal was created
  priceAtTrade    Decimal? @db.Decimal(36, 18) // Token price when we tried to buy
  priceChangePercent Float? // % change from signal to trade attempt

  // Position tracking (for linking buy to sell)
  positionId      String?  // Links buy and sell trades of same position
  exitReason      String?  // 'stop_loss' | 'take_profit' | 'manual' | 'trailing_stop'

  // PnL (filled when position closes)
  realizedPnlSol     Decimal? @db.Decimal(36, 18)
  realizedPnlPercent Decimal? @db.Decimal(36, 18)
  realizedPnlUsd     Decimal? @db.Decimal(36, 18)

  // Wallets that triggered the signal
  triggerWallets  Json?    // Array of { address, label, score }

  // Timestamps
  signalTimestamp DateTime? // When signal was received
  executedAt      DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([tokenMint])
  @@index([signalType])
  @@index([side])
  @@index([success])
  @@index([executedAt])
  @@index([positionId])
}

// ============================================================================
// SIGNAL GATE CHECK LOGGING (ČÁST 12)
// ============================================================================

/// Logs all gate check results for each potential NINJA signal
/// Used for analysis of why signals were blocked or passed
model SignalGateCheck {
  id              String   @id @default(cuid())
  tokenMint       String
  tokenSymbol     String?

  // Market data at check time
  marketCapUsd    Decimal? @db.Decimal(36, 18)
  liquidityUsd    Decimal? @db.Decimal(36, 18)

  // LIQUIDITY GATE results
  liquidity5minChange      Decimal? @db.Decimal(36, 18)  // % change (negative = drop)
  liquidity15minChange     Decimal? @db.Decimal(36, 18) // % change (negative = drop)
  liquidityMcapRatio       Decimal? @db.Decimal(36, 18) // Ratio (0-1)
  liquidityGatePassed      Boolean  @default(false)
  liquidityGateReason      String?

  // MOMENTUM GATE results
  buySellVolumeRatio       Decimal? @db.Decimal(36, 18) // Buy/Sell volume ratio
  buyerSellerRatio         Decimal? @db.Decimal(36, 18) // Unique buyers/sellers ratio
  priceMomentum5min        Decimal? @db.Decimal(36, 18) // % price change
  priceAboveMa1min         Boolean  @default(false)
  priceAboveMa5min         Boolean  @default(false)
  momentumGatePassed       Boolean  @default(false)
  momentumGateReason       String?

  // RISK GATE results
  largeSellDetected        Boolean  @default(false)  // >1% supply sell
  largeSellPercent         Decimal? @db.Decimal(36, 18)
  largeSellValueUsd        Decimal? @db.Decimal(36, 18)
  riskGatePassed           Boolean  @default(false)
  riskGateReason           String?

  // WALLET GATE results (tier-specific)
  tier                     String?   // Tier 1, Tier 2, etc.
  walletCount              Int?
  requiredWallets          Int?
  uniqueBuyersInWindow     Int?
  requiredUniqueBuyers     Int?
  qualityWalletCount       Int?
  requiredQualityWallets   Int?
  walletGatePassed         Boolean  @default(false)
  walletGateReason         String?

  // Overall result
  allGatesPassed           Boolean  @default(false)
  signalEmitted            Boolean  @default(false)
  blockReason              String?  // First gate that failed

  // Priority fee if signal was emitted
  priorityFeeLamports      Int?
  priorityFeeReason        String?

  createdAt                DateTime @default(now())

  @@index([tokenMint])
  @@index([createdAt])
  @@index([allGatesPassed])
  @@index([signalEmitted])
}

/// Daily aggregated statistics for monitoring and reporting
model DailyStats {
  id                    String   @id @default(cuid())
  date                  DateTime @unique // Date at midnight UTC

  // Signal statistics
  signalsReceived       Int      @default(0) // Total potential signals checked
  signalsBlocked        Int      @default(0) // Signals that failed gates
  signalsEmitted        Int      @default(0) // Signals that passed all gates

  // Gate failure breakdown
  blockedByLiquidity    Int      @default(0)
  blockedByMomentum     Int      @default(0)
  blockedByRisk         Int      @default(0)
  blockedByWallet       Int      @default(0)
  blockedByMcap         Int      @default(0)
  blockedByOther        Int      @default(0)

  // Trade statistics
  tradesExecuted        Int      @default(0)
  tradesSuccessful      Int      @default(0)
  tradesFailed          Int      @default(0)

  // PnL statistics
  totalPnlSol           Decimal  @default(0) @db.Decimal(36, 18)
  totalPnlUsd           Decimal  @default(0) @db.Decimal(36, 18)
  wins                  Int      @default(0)
  losses                Int      @default(0)
  winRate               Decimal? @db.Decimal(36, 18)
  avgWinPercent         Decimal? @db.Decimal(36, 18)
  avgLossPercent        Decimal? @db.Decimal(36, 18)
  largestWinPercent     Decimal? @db.Decimal(36, 18)
  largestLossPercent    Decimal? @db.Decimal(36, 18)

  // Position statistics
  positionsOpened       Int      @default(0)
  positionsClosed       Int      @default(0)
  avgHoldTimeMinutes    Decimal? @db.Decimal(36, 18)

  // Exit reason breakdown
  exitsBySl             Int      @default(0)
  exitsByTp1            Int      @default(0)
  exitsByTp2            Int      @default(0)
  exitsByTp3            Int      @default(0)
  exitsByTime           Int      @default(0)
  exitsByEmergency      Int      @default(0)
  exitsByWhaleDump      Int      @default(0)

  // Max drawdown tracking
  maxDrawdownPercent    Decimal? @db.Decimal(36, 18)

  // SOL price range (for context)
  solPriceOpen          Decimal? @db.Decimal(36, 18)
  solPriceClose         Decimal? @db.Decimal(36, 18)
  solPriceHigh          Decimal? @db.Decimal(36, 18)
  solPriceLow           Decimal? @db.Decimal(36, 18)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([date])
}
